---
title: "01_Deidentify_and_Clean"
author: "Abraham Ybarra"
date: '2023-02-03'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r}
library(tidyverse)
library(here)
```

# Function to extract section ID based on gradebook 

```{r}

get_section=function(path, section){
  section = read.csv(path) %>%
    filter(!is.na(SIS.User.ID)) %>%
    filter(Student != "Student, Test") %>%
    select(SIS.User.ID, Section) %>% 
    rename(Section.Id=Section, SIS.Id=SIS.User.ID) %>%
    mutate(Section.Id = gsub('PSYC 2145', section, Section.Id))
  return(section)
}

f1_section = get_section(paste0(here(),"/raw_data/F21/gradebook.csv"), 'F21')
#f2_section = get_section(paste0(here(),"/raw_data/F22/gradebook.csv"), 'F22')

```

## Read in data

```{r}
######## Read in F21 Data ############
studentSummary <- read.csv(paste0(here(),"/raw_data/F21/studentSummary.csv"), header = TRUE) %>%
  #mergeing in section data
  merge(f1_section, on=c('SIS.Id')) # N = 181
late <- read.csv(paste0(here(),"/raw_data/F21/lateAssignments.csv"), header = TRUE)
missing <- read.csv(paste0(here(),"/raw_data/F21/missingAssignments.csv"), header = TRUE)
grades <- read.csv(paste0(here(),"/raw_data/F21/gradebook.csv"), header = TRUE) # N = 178 (why?)

# Read in the data
assignments <- read.csv(paste0(here(),"/raw_data/psyc_students_report_split.csv"), 
                        header = TRUE, numerals = "no.loss") # N = 181
```

## Deidentify data pulled directly from Canvas

```{r}
######## Rename column to be joined (SIS id) to match in all datasets ############
# Randomize the order of rows in the dataset before assigning random id to remove possibility to identify
set.seed(123)
studentSummary = studentSummary[sample(1:nrow(studentSummary)), ]
rownames(studentSummary) <- 1:nrow(studentSummary)  # reset row index

studentSummary <- studentSummary %>%
  rename(Student.Name = Sortable.name) %>%
  mutate(Random.Id=row_number()) %>%
  select(Student.Name, Random.Id, Overall.course.grade, Assignment.on.time.percent, Page.Views, Participations)

grades <- grades %>%
  rename(Student.Name = Student)

######## Join to late assignments and remove identifying info ############
late <- late %>%
  inner_join(studentSummary, by = "Student.Name") %>%
  select(Random.Id, Assignment.Name, Points.Possible, Due.Date, Unlocked.Date, Submitted.Date,
         Overall.course.grade, Assignment.on.time.percent, Page.Views, Participations)
  
######## Join to missing assignments and remove identifying info ############
missing <- missing %>%
  inner_join(studentSummary, by = "Student.Name") %>%
  select(Random.Id, Assignment.Name, Points.Possible, Due.Date, Unlocked.Date,
         Overall.course.grade, Assignment.on.time.percent, Page.Views, Participations)

######## Join to grade book and remove identifying info ############
# TODO Why are there more students in summary than in grade book?
# "West, Ruairhi" – "Barr, Charlemagne" – "Schachtel, Julia"
grades <- grades %>%
  inner_join(studentSummary, by = "Student.Name") 

grades <- grades %>%
  select(!c(Student.Name:Section)) %>%
  select(Random.Id, everything())

######## Remove identifying info from student summary, grab final exam score ############
# TODO Verify final exam score
studentSummary <- studentSummary %>%
  inner_join(grades %>% select(Random.Id, Final.Exam.Component.Scores..WEIGHTED.0...IGNORE..Unposted.Current.Score), by = 'Random.Id') %>%
  rename(Final.Exam.Score = Final.Exam.Component.Scores..WEIGHTED.0...IGNORE..Unposted.Current.Score) %>%
  relocate(Final.Exam.Score, .after = Overall.course.grade) %>%
  select(!Student.Name)
```

## Clean data from OIT

```{r}
# Read in the data
assignments <- read.csv(paste0(here(),"/raw_data/psyc_students_report_split.csv"), 
                        header = TRUE, numerals = "no.loss") # N = 181

# Keep only relevant columns
assignments <- assignments %>%
  select(ANON_ID, CURRENT_SCORE, ASSIGNMENT_ID, ASSIGNMENT_NAME, SCORE, 
         DUE_DATE, DUE_DATE_DATE, DUE_DATE_TIME, SUBMITTED_AT, SUBMITTED_AT_DATE,
         SUBMITTED_AT_TIME, ASSIGNMENT_OPEN, ASSIGNMENT_OPEN_DATE, ASSIGNMENT_OPEN_TIME, ASSIGNMENT_CLOSE,
         ASSIGNMENT_CLOSE_DATE, ASSIGNMENT_CLOSE_TIME, SUBMITTED_FLAG, POINTS_POSSIBLE,LAST_ACTIVITY_AT,
         LAST_ACTIVITY_AT_DATE, LAST_ACTIVITY_AT_TIME,
         CLASS_SECTION_CD, SECTION_ID, SEMESTER_START, SEMESTER_END)

# Indicate class section (TODO: Which is Ashley's?), rearrange columns
assignments <- assignments %>%
  mutate(YEAR = ifelse(grepl("21", SEMESTER_START),"2021","2022"), .after = SEMESTER_END) %>%
  mutate(YEAR_SECTION = paste(YEAR, CLASS_SECTION_CD), .after = ANON_ID) # Show year + section

# Separate by year
assignments_21 <- assignments %>%
  filter(SEMESTER_END == "12/15/21")

assignments_22 <- assignments %>% 
  filter(SEMESTER_END == "12/14/22")
```

## Clean 2021 dataset specifically

```{r}
assignment_list_21 = unique(assignments_21$ASSIGNMENT_NAME) # list of all assignments
num_assignments = length(assignment_list_21) # total number of assignments (N = 108)

# Sort assignments by due date (thereby organizing by name as well)
assignments_21 <- assignments_21 %>%
  arrange(DUE_DATE)

# Print the names of all assignments with missing due dates
missing_due_21 <- assignments_21 %>%
  filter(DUE_DATE == "")
list_missing_due = unique(missing_due_21$ASSIGNMENT_NAME)
num_missing_due = length(list_missing_due)

# print the names of all assignments flagged as submitted but with no submission time
submit_noTime_21 <- assignments_21 %>%
  filter(SUBMITTED_FLAG == "True" & SUBMITTED_AT == "")
list_missing_submit = unique(submit_noTime_21$ASSIGNMENT_NAME)
num_missing_submit = length(list_missing_submit)
```

## Write deidentified datasets

```{r}
######## Write cleaned F21 (Ashley) data to csv file ################
write.csv(studentSummary,paste0(here(),"/clean_data/F21_Ashley/studentSummary.csv"),row.names = FALSE)
write.csv(late,paste0(here(),"/clean_data/F21_Ashley/lateAssignments.csv"),row.names = FALSE)
write.csv(missing,paste0(here(),"/clean_data/F21_Ashley/missingAssignments.csv"),row.names = FALSE)
write.csv(grades,paste0(here(),"/clean_data/F21_Ashley/gradebook.csv"),row.names = FALSE)

#write.csv(assignments,paste0(here(),"/clean_data/F21_Ashley/allAssignments.csv"),row.names = FALSE)
```







