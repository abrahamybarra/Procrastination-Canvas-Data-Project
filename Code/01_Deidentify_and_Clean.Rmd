---
title: "01_Deidentify_and_Clean"
author: "Abraham Ybarra"
date: '2023-02-03'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r}
library(tidyverse)
library(here)
```

## Read in data

```{r}
######## Read in F21 Data ############
studentSummary <- read.csv(paste0(here(),"/raw_data/F21/studentSummary.csv"), header = TRUE) # N = 181
late <- read.csv(paste0(here(),"/raw_data/F21/lateAssignments.csv"), header = TRUE)
missing <- read.csv(paste0(here(),"/raw_data/F21/missingAssignments.csv"), header = TRUE)
grades <- read.csv(paste0(here(),"/raw_data/F21/gradebook.csv"), header = TRUE) # N = 178 (why?)
```

## Deidentify data

```{r}
######## Rename column to be joined (SIS id) to match in all datasets ############
# Randomize the order of rows in the dataset before assigning random id to remove possibility to identify
set.seed(123)
studentSummary = studentSummary[sample(1:nrow(studentSummary)), ]
rownames(studentSummary) <- 1:nrow(studentSummary)  # reset row index

studentSummary <- studentSummary %>%
  rename(Student.Name = Sortable.name) %>%
  mutate(Random.Id=row_number()) %>%
  select(Student.Name, Random.Id, Overall.course.grade, Assignment.on.time.percent, Page.Views, Participations)

grades <- grades %>%
  rename(Student.Name = Student)

######## Join to late assignments and remove identifying info ############
late <- late %>%
  inner_join(studentSummary, by = "Student.Name") %>%
  select(Random.Id, Assignment.Name, Points.Possible, Due.Date, Unlocked.Date, Submitted.Date,
         Overall.course.grade, Assignment.on.time.percent, Page.Views, Participations)
  
######## Join to missing assignments and remove identifying info ############
missing <- missing %>%
  inner_join(studentSummary, by = "Student.Name") %>%
  select(Random.Id, Assignment.Name, Points.Possible, Due.Date, Unlocked.Date,
         Overall.course.grade, Assignment.on.time.percent, Page.Views, Participations)

######## Join to grade book and remove identifying info ############
# TODO Why are there more students in summary than in grade book?
# "West, Ruairhi" – "Barr, Charlemagne" – "Schachtel, Julia"
grades <- grades %>%
  inner_join(studentSummary, by = "Student.Name") 

grades <- grades %>%
  select(!c(Student.Name:Section)) %>%
  select(Random.Id, everything())

######## Remove identifying info from student summary, grab final exam score ############
# TODO Verify final exam score
studentSummary <- studentSummary %>%
  inner_join(grades %>% select(Random.Id, Final.Exam.Component.Scores..WEIGHTED.0...IGNORE..Unposted.Current.Score), by = 'Random.Id') %>%
  rename(Final.Exam.Score = Final.Exam.Component.Scores..WEIGHTED.0...IGNORE..Unposted.Current.Score) %>%
  relocate(Final.Exam.Score, .after = Overall.course.grade) %>%
  select(!Student.Name)
```

## Write deidentified datasets

```{r}
######## Write cleaned F21 (Ashley) data to csv file ################
write.csv(studentSummary,paste0(here(),"/clean_data/F21_Ashley/studentSummary.csv"),row.names = FALSE)
write.csv(late,paste0(here(),"/clean_data/F21_Ashley/lateAssignments.csv"),row.names = FALSE)
write.csv(missing,paste0(here(),"/clean_data/F21_Ashley/missingAssignments.csv"),row.names = FALSE)
write.csv(grades,paste0(here(),"/clean_data/F21_Ashley/gradebook.csv"),row.names = FALSE)
```







